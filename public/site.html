<script>
    document.getElementById("chatForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        sendMessage();
    });

    document.getElementById("message").addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    async function sendMessage() {
        const inputElement = document.getElementById("message");
        const message = inputElement.value;
        const characterId = "1"; // Hardcoded character ID

        if (!message.trim()) return;

        const messagesDiv = document.getElementById("messages");

        // Add user message
        const userMessageContainer = document.createElement("div");
        userMessageContainer.className = "message-container user";

        const userMessage = document.createElement("div");
        userMessage.className = "user-message";
        userMessage.innerText = message;

        userMessageContainer.appendChild(userMessage);
        messagesDiv.appendChild(userMessageContainer);

        // Clear the input field
        inputElement.value = "";

        // Scroll to the bottom
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        try {
            const response = await fetch("https://carrd-chatbot.vercel.app/api/reply", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ message, characterId }), // Include characterId in payload
            });

            const data = await response.json();

            // Add bot reply
            const botMessageContainer = document.createElement("div");
            botMessageContainer.className = "message-container bot";

            const botMessage = document.createElement("div");
            botMessage.className = "bot-message";
            botMessage.innerText = data.reply || "Error: " + data.error;

            botMessageContainer.appendChild(botMessage);
            messagesDiv.appendChild(botMessageContainer);

            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        } catch (error) {
            const botMessageContainer = document.createElement("div");
            botMessageContainer.className = "message-container bot";

            const botMessage = document.createElement("div");
            botMessage.className = "bot-message";
            botMessage.innerText = "Error: Unable to connect to the server.";

            botMessageContainer.appendChild(botMessage);
            messagesDiv.appendChild(botMessageContainer);

            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    }
</script>
