<script>
    async function loginWithTwitter() {
        try {
            const authResponse = await fetch("/api/twitter/auth");
            const { redirectUrl, codeVerifier } = await authResponse.json();

            localStorage.setItem("code_verifier", codeVerifier); // Store the codeVerifier temporarily

            const twitterLoginWindow = window.open(
                redirectUrl,
                "TwitterLogin",
                "width=600,height=600"
            );
        } catch (error) {
            console.error("Twitter Authentication Error:", error);
        }
    }

    // Listen for messages from child windows
    window.addEventListener("message", (event) => {
        if (event.data.logged_in) {
            localStorage.setItem("username", event.data.username);
            localStorage.setItem("name", event.data.name);
            window.location.href = "/site.html"; // Redirect after successful login
        }
    });

    document.getElementById("login-button").addEventListener("click", loginWithTwitter);
</script>
